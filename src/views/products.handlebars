<div class="container my-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">Lista de productos</h1>
    <a href="/carts/68a78dc15fcdfa3c052524e6" class="btn btn-outline-primary">
      ðŸ›’ Ver Carrito
    </a>
  </div>

  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {{#each products}}
      <div class="col">
        <div class="card h-100 shadow-sm">
          <img src="{{this.thumbnails.[0]}}" class="card-img-top" alt="{{this.title}}" style="height: 200px; object-fit: cover;" />
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{this.title}}</h5>
            <p class="card-text">{{this.description}}</p>
            <p class="card-text"><strong>ðŸ’µ Precio:</strong> ${{this.price}}</p>

            <div class="mb-3">
              <label for="qty-{{this._id}}" class="form-label">Cantidad:</label>
              <input type="number" id="qty-{{this._id}}" class="form-control" min="1" value="1" data-id="{{this._id}}" />
            </div>

            <button class="btn btn-primary mt-auto add-to-cart" data-id="{{this._id}}">
              âž• Agregar al carrito
            </button>
          </div>
        </div>
      </div>
    {{/each}}
  </div>

  <!-- PaginaciÃ³n -->
  <div class="d-flex justify-content-between align-items-center mt-5">
    {{#if hasPrevPage}}
      <a class="btn btn-outline-secondary" href="?page={{prevPage}}&limit={{limit}}&sort={{sort}}&query={{query}}">
        â¬… Anterior
      </a>
    {{else}}
      <div></div>
    {{/if}}

    <span class="fw-bold">PÃ¡gina {{page}} de {{totalPages}}</span>

    {{#if hasNextPage}}
      <a class="btn btn-outline-secondary" href="?page={{nextPage}}&limit={{limit}}&sort={{sort}}&query={{query}}">
        Siguiente âž¡
      </a>
    {{else}}
      <div></div>
    {{/if}}
  </div>
</div>

<!-- Script -->
<script>
  const CART_ID = '68a78dc15fcdfa3c052524e6';

  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', async () => {
      const pid = btn.dataset.id;
      const qtyInput = document.querySelector(`#qty-${pid}`);
      const quantity = Number(qtyInput?.value || 1);

      try {
        const res = await fetch(`/api/carts/${CART_ID}/products/${pid}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity })
        });

        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Error al agregar');
          return;
        }
        alert('âœ… Agregado al carrito');
      } catch (err) {
        console.error(err);
        alert('Error de red');
      }
    });
  });
</script>